@attribute [Route($"/{Routing.Lesson}")]

@using JDev.Tuteee.Protos
@using JDev.Tuteee.Rest.ApiClient.ApiClients
@using JDev.Tuteee.Rest.ApiClient.DTOs
@using Microsoft.AspNetCore.Authorization

@inherits JDev.Tuteee.Identity.Components.CancellableComponentBase

@inject IRestApiClient RestApiClient
@inject Homework.HomeworkClient HomeworkClient
@inject NavigationManager NavigationManager
@inject IJSRuntime JsRuntime
@attribute [StreamRendering]
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]

<PageTitle>@TuteeName</PageTitle>

<Breadcrumb Items="_navItems"></Breadcrumb>

<Modal @ref="_fileUploadModal" Title="Select file for upload">
    <BodyTemplate>
        <div class="d-flex flex-column">
            <InputFile OnChange="LoadFile"/>
            Filename
            <TextInput @bind-Value="@_filename"/>
        </div>
    </BodyTemplate>
    <FooterTemplate>
        <Button Color="ButtonColor.Primary" @onclick="OnHideAddAttachmentModal">Add attachment</Button>
    </FooterTemplate>
</Modal>

<Modal @ref="_deleteLessonConfirmationModal" Title="Delete lesson?">
    <BodyTemplate>
        Are you sure you want to delete the lesson?
    </BodyTemplate>
    <FooterTemplate>
        <Button Color="ButtonColor.Danger" @onclick="OnHideDeleteLessonConfirmationModal">Confirm</Button>
    </FooterTemplate>
</Modal>

<Modal @ref="_homeworkEditModal" Title="What are the homework instructions?">
    <BodyTemplate>
        Instructions
        <div class="d-flex flex-column">
            <TextInput @bind-Value="@_homeworkInstructions"/>
        </div>
    </BodyTemplate>
    <FooterTemplate>
        <Button Color="ButtonColor.Primary" @onclick="OnHideEditHomeworkInstructionsModal">Confirm</Button>
    </FooterTemplate>
</Modal>

@if (_lesson is null)
{
    <p>
        <em>Loading...</em>
    </p>
}
else
{
    <div class="d-flex flex-row-reverse">
        <Button Color="ButtonColor.Danger" @onclick="OnShowDeleteLessonConfirmationModal">Delete lesson</Button>
    </div>
    <h4>Time</h4>
    <p>@_lesson.Start.ToString("t") - @_lesson.Start.Add(_lesson.Duration).ToString("t")</p>
    <h4>Cost</h4>
    <p>¬£@_lesson.CostString</p>
    <div class="d-flex flex-row justify-content-between my-2">
        <h4>
            Homework
            <DeadLink OnClick="OnShowEditHomeworkInstructionsModal">‚úé</DeadLink>
        </h4>
    </div>
    <p>@_lesson.HomeworkInstructions</p>
    <div class="d-flex flex-row my-2">
        <Button style="margin-right: 2px" Color="ButtonColor.Primary" @onclick="OnShowAddAttachmentModal">Add attachments</Button>
        <Button Disabled="@_lesson.EmailSent" Color="ButtonColor.Danger" @onclick="OnReleaseHomework">Release</Button>
    </div>
    @foreach (var ha in _homeworkAttachments)
    {
        <div class="d-flex flex-row">
            <DeadLink OnClick="() => DownloadFile(ha)">@Path.GetFileName(ha.FileName)</DeadLink>
            <div class="mx-2">
                <DeadClick OnClick="() => DeleteFile(ha)">üóëÔ∏è</DeadClick>
            </div>
        </div>
    }
}

<script>
    window.downloadFileFromStream = async (fileName, contentStreamReference) => {
        const arrayBuffer = await contentStreamReference.arrayBuffer();
        const blob = new Blob([arrayBuffer]);
        const url = URL.createObjectURL(blob);
        const anchorElement = document.createElement('a');
        anchorElement.href = url;
        anchorElement.download = fileName ?? '';
        anchorElement.click();
        anchorElement.remove();
        URL.revokeObjectURL(url);
    }
</script>

@code {
    [Parameter]
    public int LessonId { get; set; }
    private List<BreadcrumbItem> _navItems = default!;
    private Modal _fileUploadModal = default!;
    private Modal _homeworkEditModal = default!;
    private Modal _deleteLessonConfirmationModal = default!;
    private LessonDto? _lesson;
    private TuteeDto? _tutee;
    private ClientDto? _client;
    private IReadOnlyList<HomeworkAttachmentDto> _homeworkAttachments = [];
    private string _filename = default!;
    private string _homeworkInstructions = default!;
    private string _temporaryFileName = default!;

    private string TuteeName => $"{_tutee?.GetFirstName()} {_tutee?.GetLastName()}".Trim();
    private string ClientName => $"{_client?.FirstName} {_client?.LastName}";

    protected override async Task OnInitializedAsync()
    {
        _lesson = await RestApiClient.GetLessonAsync(LessonId, CancellationToken);
        _homeworkInstructions = _lesson.HomeworkInstructions;
        _tutee = _lesson.Tutee;
        _client = _tutee.Client;
        _homeworkAttachments = await RestApiClient.GetHomeworkAttachmentsAsync(LessonId, CancellationToken);
        _navItems =
        [
            new BreadcrumbItem { Text = $"{ClientName} üìÇ", Href = $"clients/{_client!.ClientId}" },
            new BreadcrumbItem { Text = $"{TuteeName} üéì", Href = $"tutees/{_tutee.TuteeId}" },
            new BreadcrumbItem { Text = $"{_lesson.Date:D} üìö", IsCurrentPage = true }
        ];
    }

    private async Task DownloadFile(HomeworkAttachmentDto dto)
    {
        var response = await RestApiClient.GetHomeworkAttachmentAsync(dto.HomeworkAttachmentId, CancellationToken);
        var fileName = Path.GetFileName(response.FileName);
        var stream = new MemoryStream(response.Contents);
        using var streamRef = new DotNetStreamReference(stream: stream);
        await JsRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
    }
    
    private async Task DeleteFile(HomeworkAttachmentDto dto)
    {
        await RestApiClient.DeleteHomeworkAttachmentAsync(dto.HomeworkAttachmentId, CancellationToken);
        _homeworkAttachments = await RestApiClient.GetHomeworkAttachmentsAsync(_lesson.LessonId.Value, CancellationToken);
    }


    private async Task OnShowAddAttachmentModal()
    {
        await _fileUploadModal.ShowAsync();
    }
    private async Task OnHideAddAttachmentModal()
    {
        await RestApiClient.SaveHomeworkAttachmentAsync(_lesson.LessonId.Value, new HomeworkAttachmentDto
        {
            FileName = _filename,
            TemporaryFileName = _temporaryFileName,
            LessonId = _lesson!.LessonId
        }, CancellationToken);
        _homeworkAttachments = await RestApiClient.GetHomeworkAttachmentsAsync(LessonId, CancellationToken);
        await _fileUploadModal.HideAsync();
    }

    private async Task OnShowEditHomeworkInstructionsModal()
    {
        await _homeworkEditModal.ShowAsync();
    }
    private async Task OnReleaseHomework()
    {
        await HomeworkClient.ReleaseAsync(new ReleaseRequest
        {
            LessonId = LessonId
        });
        _lesson = await RestApiClient.GetLessonAsync(LessonId, CancellationToken);
    }
    
    private async Task OnHideEditHomeworkInstructionsModal()
    {
        _lesson.HomeworkInstructions = _homeworkInstructions;
        await RestApiClient.UpdateLessonAsync(_lesson, CancellationToken);
        _lesson = await RestApiClient.GetLessonAsync(LessonId, CancellationToken);
        await _homeworkEditModal.HideAsync();
    }

    private async Task LoadFile(InputFileChangeEventArgs obj)
    {
        var file = obj.File;
        var tempName = $"{Guid.NewGuid()}{Path.GetExtension(file.Name)}";
        _temporaryFileName = tempName;
        _filename = file.Name;
        using var memoryStream = new MemoryStream();
        await file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).CopyToAsync(memoryStream);
        var byteArray = memoryStream.ToArray();
        await RestApiClient.SaveTemporaryFileAsync(new FileDto
        {
            Contents = byteArray,
            FileName = tempName
        }, CancellationToken);
    }

    private async Task OnShowDeleteLessonConfirmationModal()
    {
        await _deleteLessonConfirmationModal.ShowAsync();
    }

    private async Task OnHideDeleteLessonConfirmationModal()
    {
        await RestApiClient.DeleteLessonAsync(LessonId, CancellationToken);
        await _deleteLessonConfirmationModal.HideAsync();
        NavigationManager.NavigateTo($"tutees/{_tutee.TuteeId}");
    }

}